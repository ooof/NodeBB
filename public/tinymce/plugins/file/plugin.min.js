/**
 * plugin.js
 *
 * Released under LGPL License.
 * Copyright (c) 1999-2015 Ephox Corp. All rights reserved
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*global tinymce:true */

tinymce.PluginManager.add('file', function (editor) {
	function uploadFile(callback) {
		return function() {
			callback();
		}
	}

	function showDialog() {
		var win, data = {}, dom = editor.dom, figureElm;
		var imageListCtrl, classListCtrl, imageDimensions = editor.settings.image_dimensions !== false;

		function onSubmitForm() {
			window.tempUploadFile();
		}

		function removePixelSuffix(value) {
			if (value) {
				value = value.replace(/px$/, '');
			}

			return value;
		}

		function srcChange(e) {
			var srcURL, prependURL, absoluteURLPattern, meta = e.meta || {};

			if (imageListCtrl) {
				imageListCtrl.value(editor.convertURL(this.value(), 'src'));
			}

			tinymce.each(meta, function (value, key) {
				win.find('#' + key).value(value);
			});

			if (!meta.width && !meta.height) {
				srcURL = editor.convertURL(this.value(), 'src');

				// Pattern test the src url and make sure we haven't already prepended the url
				prependURL = editor.settings.image_prepend_url;
				absoluteURLPattern = new RegExp('^(?:[a-z]+:)?//', 'i');
				if (prependURL && !absoluteURLPattern.test(srcURL) && srcURL.substring(0, prependURL.length) !== prependURL) {
					srcURL = prependURL + srcURL;
				}

				this.value(srcURL);
			}
		}

		imgElm = editor.selection.getNode();
		figureElm = dom.getParent(imgElm, 'figure.image');
		if (figureElm) {
			imgElm = dom.select('img', figureElm)[0];
		}

		if (imgElm && (imgElm.nodeName != 'IMG' || imgElm.getAttribute('data-mce-object') || imgElm.getAttribute('data-mce-placeholder'))) {
			imgElm = null;
		}

		if (imgElm) {
			data = {
				src: dom.getAttrib(imgElm, 'src'),
			};
		}


		// General settings shared between simple and advanced dialogs
		var generalFormItems = [
		];

		function uploadFile(e) {
			window.postFile = $($(e.target).parents('.mce-container')[0]).siblings('label');
			$('#post-file-upload').trigger('click');
		}

		generalFormItems.push({
			type: 'container',
			label: '请点击右侧图标上传文件',
			layout: 'flex',
			direction: 'row',
			align: 'center',
			spacing: 5,
			items: [
				{
					type: 'button',
					icon: 'browse',
					onclick: uploadFile
				}
			]
		});

		// Simple default dialog
		win = editor.windowManager.open({
			title: '上传文件',
			data: data,
			body: generalFormItems,
			onSubmit: onSubmitForm
		});
	}

	editor.on('preInit', function () {
	});

	editor.addButton('file', {
		icon: 'link',
		tooltip: '上传文件',
		onclick: uploadFile(showDialog),
		stateSelector: 'img:not([data-mce-object],[data-mce-placeholder]),figure.image'
	});
});
